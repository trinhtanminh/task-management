<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRỊNH TẤN MINH - QUẢN LÝ MEDIA</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .task-card.platform-youtube { border-left-color: #FF0000; }
        .task-card.platform-facebook { border-left-color: #1877F2; }
        .task-card.platform-tiktok { border-left-color: #000000; }
        .task-card.platform-unknown { border-left-color: #6b7280; } /* Fallback color */

        .status-chua-lam { background-color: #e5e7eb; color: #4b5563; }
        .status-dang-lam { background-color: #dbeafe; color: #1d4ed8; }
        .status-hoan-thanh { background-color: #d1fae5; color: #065f46; }
        .status-bu { background-color: #fef3c7; color: #92400e; }
        
        /* Modal Transition Styles */
        .modal-content {
            transition: all 0.3s ease-out;
        }

        /* Custom scrollbar for chat lists */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Config Error Message -->
    <div id="config-error" class="hidden">
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-8 m-4 rounded-lg shadow-lg" role="alert">
            <p class="font-bold text-2xl">Lỗi Cấu Hình Firebase</p>
            <p class="mt-4">Vui lòng thay thế các giá trị placeholder trong biến <strong>firebaseConfig</strong> trong mã nguồn bằng thông tin cấu hình Firebase thực tế của bạn.</p>
            <p class="mt-2">Bạn có thể tìm thấy thông tin này trong phần Cài đặt dự án (Project settings) trên Firebase Console.</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="flex items-center justify-center min-h-screen hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-800 mb-6">Đăng Nhập</h2>
            <div id="auth-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
            <form id="auth-form">
                <div id="name-field-container" class="hidden mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Tên</label>
                    <input id="name" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nguyễn Văn A">
                </div>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input id="email" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required placeholder="email@example.com">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                    <input id="password" type="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required placeholder="••••••••">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Đăng Nhập</button>
            </form>
            <p class="text-center text-sm text-gray-600 mt-6">
                <span id="auth-toggle-text">Chưa có tài khoản?</span>
                <a href="#" id="auth-toggle-link" class="font-medium text-indigo-600 hover:text-indigo-500">Đăng ký ngay</a>
            </p>
        </div>
    </div>

    <!-- Main App (User View) -->
    <div id="app-screen" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h1 id="header-title" class="text-xl md:text-2xl font-bold text-gray-800">Các Nhóm Của Tôi</h1>
                        <button id="back-to-dashboard-btn" class="hidden bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                            <i class="fas fa-arrow-left mr-2"></i>Quay lại
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="user-email" class="hidden md:block text-sm text-gray-600"></span>
                        <button id="friends-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                            <i class="fas fa-user-friends mr-2"></i>Bạn bè
                        </button>
                        <button id="leave-group-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                            <i class="fas fa-sign-out-alt mr-2"></i>Rời nhóm
                        </button>
                        <button id="create-group-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                            <i class="fas fa-plus mr-2"></i>Tạo nhóm
                        </button>
                        <button id="join-group-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                            <i class="fas fa-user-plus mr-2"></i>Tham gia
                        </button>
                        <button id="logout-btn" class="bg-gray-200 text-gray-800 w-10 h-10 rounded-lg hover:bg-gray-300 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content-container" class="container mx-auto p-4">
            <div id="stats-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 hidden"></div>
            <div id="main-content"></div>
        </main>
    </div>

    <!-- Admin Screen -->
    <div id="admin-screen" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">Trang Quản Trị</h1>
                <div class="flex items-center gap-3">
                    <span id="admin-email" class="hidden md:block text-sm text-gray-600 font-semibold"></span>
                    <button id="admin-logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                    </button>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4">
            <!-- Admin Dashboard Stats -->
            <div id="admin-stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Stats will be loaded here by JS -->
            </div>

            <!-- Growth Chart -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="h-80">
                   <canvas id="user-growth-chart"></canvas>
                </div>
            </div>

            <!-- User Management -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Quản Lý Người Dùng</h2>
                    <button id="add-user-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Thêm người dùng
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Tên</th>
                                <th scope="col" class="px-6 py-3">Email</th>
                                <th scope="col" class="px-6 py-3">Ngày tham gia</th>
                                <th scope="col" class="px-6 py-3">Vai trò</th>
                                <th scope="col" class="px-6 py-3">Trạng thái</th>
                                <th scope="col" class="px-6 py-3">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- User rows will be inserted here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-lg w-full max-w-md transform transition-all scale-95 opacity-0">
            <h3 id="user-modal-title" class="text-xl font-bold text-gray-800 mb-6"></h3>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="mb-4">
                    <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Tên người dùng</label>
                    <input type="text" id="user-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="user-email-input" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="user-email-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div id="password-field-container" class="mb-6">
                    <label for="user-password" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                    <input type="password" id="user-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">Bỏ trống nếu không muốn thay đổi mật khẩu.</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" onclick="closeModal('user-modal')">Hủy</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-lg w-full max-w-lg transform transition-all scale-95 opacity-0">
            <h3 id="task-modal-title" class="text-xl font-bold text-gray-800 mb-6">Tạo công việc mới</h3>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <input type="hidden" id="task-time">
                <input type="hidden" id="task-date">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-partner" class="block text-sm font-medium text-gray-700 mb-1">Đối tác</label>
                        <input type="text" id="task-partner" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                     <div>
                        <label for="task-platform" class="block text-sm font-medium text-gray-700 mb-1">Nền tảng</label>
                        <select id="task-platform" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            <option value="YouTube">YouTube</option>
                            <option value="Facebook">Facebook</option>
                            <option value="TikTok">TikTok</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="task-content" class="block text-sm font-medium text-gray-700 mb-1">Nội dung</label>
                    <textarea id="task-content" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" required></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="task-status" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                        <select id="task-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                           <option value="Chưa làm">Chưa làm</option>
                           <option value="Đang làm">Đang làm</option>
                           <option value="Hoàn thành">Hoàn thành</option>
                           <option value="Bù">Công việc bù</option>
                       </select>
                    </div>
                    <div>
                        <label for="task-assignee" class="block text-sm font-medium text-gray-700 mb-1">Giao cho</label>
                        <select id="task-assignee" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>


                <div class="flex justify-between items-center">
                    <button type="button" id="delete-task-btn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Xóa</button>
                    <div class="flex gap-3">
                         <button type="button" onclick="closeModal('task-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Hủy</button>
                         <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="group-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-lg w-full max-w-md transform transition-all scale-95 opacity-0">
            <h3 id="group-modal-title" class="text-xl font-bold text-gray-800 mb-6">Tạo nhóm mới</h3>
            <form id="group-form">
                <div id="create-group-view">
                    <div class="mb-4">
                        <label for="new-group-name" class="block text-sm font-medium text-gray-700 mb-1">Tên nhóm</label>
                        <input type="text" id="new-group-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="VD: Team Sáng Tạo Nội Dung">
                    </div>
                    <div>
                        <label for="group-start-month" class="block text-sm font-medium text-gray-700 mb-1">Tháng bắt đầu</label>
                        <select id="group-start-month" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></select>
                    </div>
                </div>
                <div id="join-group-view" class="hidden">
                    <label for="join-group-id" class="block text-sm font-medium text-gray-700 mb-1">Mã mời nhóm</label>
                    <input type="text" id="join-group-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nhập mã mời">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" onclick="closeModal('group-modal')">Hủy</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Xác nhận</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-lg w-full max-w-sm text-center transform transition-all scale-95 opacity-0">
             <div id="confirm-icon" class="mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center bg-red-100 text-red-600 text-2xl">
                 <i class="fas fa-exclamation-triangle"></i>
             </div>
            <h3 id="confirm-title" class="text-lg font-bold text-gray-900 mb-2"></h3>
            <p id="confirm-text" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                 <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">Hủy</button>
                 <button id="confirm-ok-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Xác nhận</button>
            </div>
        </div>
    </div>


    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-lg w-full max-w-sm text-center transform transition-all scale-95 opacity-0">
            <div id="message-icon" class="text-4xl mb-4"></div>
            <h3 id="message-title" class="text-lg font-bold text-gray-900 mb-2"></h3>
            <p id="message-text" class="text-sm text-gray-600 mb-6"></p>
            <button class="bg-indigo-600 text-white w-full py-2 rounded-lg hover:bg-indigo-700" onclick="closeModal('message-modal')">Đóng</button>
        </div>
    </div>

    <!-- Friends Modal -->
    <div id="friends-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-lg w-full max-w-lg transform transition-all scale-95 opacity-0">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Quản lý bạn bè</h3>
            <div class="mb-4">
                <form id="send-friend-request-form" class="flex gap-2 mb-2">
                    <input type="email" id="friend-email-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nhập email để kết bạn" required />
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Gửi</button>
                </form>
                <div id="friend-request-message" class="hidden text-sm mb-2"></div>
            </div>
            <div class="mb-4">
                <h4 class="font-semibold text-gray-700 mb-2">Lời mời kết bạn</h4>
                <ul id="friend-requests-list" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar"></ul>
            </div>
            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Bạn bè</h4>
                <ul id="friends-list" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar"></ul>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" onclick="closeModal('friends-modal')">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Messenger Chat Button -->
    <button id="open-chat-btn" class="fixed bottom-6 right-6 z-40 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-indigo-700 transition-all">
        <i class="fab fa-facebook-messenger"></i>
    </button>

    <!-- Messenger Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50 hidden">
        <div class="modal-content bg-white rounded-t-2xl md:rounded-2xl shadow-2xl w-full max-w-3xl h-[80vh] flex flex-col md:flex-row transform transition-all scale-95 opacity-0">
            <!-- Sidebar -->
            <div class="w-full md:w-80 bg-gray-50 border-r border-gray-200 flex flex-col">
                <div class="flex items-center justify-between p-4 border-b">
                    <div class="font-bold text-lg text-gray-800">Tin nhắn</div>
                    <button onclick="closeModal('chat-modal')" class="text-gray-500 hover:text-red-500 text-xl"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex gap-2 px-4 pt-2">
                    <button id="chat-tab-group" class="flex-1 py-2 rounded-lg font-medium text-sm text-center bg-indigo-100 text-indigo-700">Nhóm</button>
                    <button id="chat-tab-friends" class="flex-1 py-2 rounded-lg font-medium text-sm text-center bg-gray-100 text-gray-700">Bạn bè</button>
                </div>
                <div id="chat-conversations-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
            </div>
            <!-- Chat Main -->
            <div id="chat-view" class="flex-1 flex flex-col h-full hidden">
                <div id="chat-header" class="p-4 border-b flex items-center gap-3">
                    <div id="chat-avatar" class="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-xl font-bold text-white"></div>
                    <div>
                        <div id="chat-title" class="font-semibold text-gray-800"></div>
                        <div id="chat-subtitle" class="text-xs text-gray-500"></div>
                    </div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 custom-scrollbar"></div>
                <form id="chat-input-form" class="flex items-center gap-2 p-4 border-t bg-white">
                    <input id="chat-input" type="text" class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nhập tin nhắn..." autocomplete="off" />
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-full hover:bg-indigo-700 transition-colors"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
            <div id="chat-placeholder" class="flex-1 flex flex-col h-full items-center justify-center bg-gray-50 p-4">
                 <i class="fa-regular fa-comments text-6xl text-gray-300 mb-4"></i>
                 <h3 class="text-lg font-semibold text-gray-600">Bắt đầu cuộc trò chuyện</h3>
                 <p class="text-sm text-gray-500">Chọn một nhóm hoặc bạn bè để xem tin nhắn.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // #############################################################################
        // ##### QUAN TRỌNG: Vui lòng thay thế bằng cấu hình Firebase của bạn #####
        // #############################################################################
        const firebaseConfig = {
            apiKey: "AIzaSyB_P4-Si9ua1b7k4W60z6tcTfK-FXdWpRs",
            authDomain: "quan-ly-media.firebaseapp.com",
            projectId: "quan-ly-media",
            storageBucket: "quan-ly-media.firebasestorage.app",
            messagingSenderId: "852239719669",
            appId: "1:852239719669:web:5016001c2f84051b9c39bc",
            measurementId: "G-EV4HZXNHNH"
        };
        // #############################################################################
        
        // Import from a recent, stable Firebase version
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection,
            onSnapshot,
            updateDoc,
            deleteDoc,
            arrayUnion,
            arrayRemove,
            query,
            where,
            getDocs,
            Timestamp,
            writeBatch,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // #############################################################################
        // ##### LƯU Ý QUAN TRỌNG VỀ PHÂN QUYỀN ADMIN (FIRESTORE SECURITY RULES) #####
        // #############################################################################
        // Các chức năng của trang Quản trị (Admin) như TẠO, SỬA, XÓA, hoặc CẬP NHẬT
        // trạng thái người dùng sẽ KHÔNG HOẠT ĐỘNG nếu bạn không cấu hình đúng
        // Firestore Security Rules.
        //
        // Mặc định, một người dùng chỉ có thể sửa đổi dữ liệu của chính họ. Để Admin
        // có thể quản lý tất cả người dùng, bạn cần cho phép họ quyền truy cập đặc biệt.
        //
        // Vui lòng vào Firebase Console -> Firestore Database -> Rules và cập nhật
        // rules của bạn để bao gồm logic kiểm tra vai trò admin. Dưới đây là một ví dụ:
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            
            // Hàm helper để kiểm tra xem người gửi yêu cầu có phải là admin không
            function isAdmin() {
              // Yêu cầu phải được xác thực và có tồn tại document trong collection 'users'
              // với role là 'admin'.
              return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
            }

            match /users/{userId} {
              // Bất kỳ ai đã đăng nhập đều có thể đọc thông tin người dùng (tùy chọn)
              allow read: if request.auth != null;
              
              // Người dùng có thể tạo và cập nhật thông tin của chính họ
              allow create, update: if request.auth.uid == userId;
              
              // Admin có thể tạo, đọc, cập nhật, xóa BẤT KỲ người dùng nào
              // Quy tắc "write" bao gồm create, update, delete.
              allow write: if isAdmin();
            }
            
            // Các rules khác cho collection 'groups', 'chats', etc.
            // ...
          }
        }
        */
        // #############################################################################


        // --- Firebase Config Check ---
        // This check ensures you've replaced the placeholder values.
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "your-project-id") {
           document.getElementById('auth-screen').classList.add('hidden');
           document.getElementById('config-error').classList.remove('hidden');
           throw new Error("Firebase config is not set. Please update the firebaseConfig object in the script.");
        }


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Admin Config ---
        const ADMIN_EMAIL = "antonyminh2025@gmail.com";

        // --- Global state ---
        let currentUser = null;
        let currentUserData = null; // Cache for current user's document data
        let isAdmin = false;
        let activeGroupId = null;
        // Listeners
        let usersUnsubscribe = null;
        let taskUnsubscribe = null;
        let groupsUnsubscribe = null;
        let groupDocUnsubscribe = null;
        let friendRequestsUnsubscribe = null;
        let chatMessagesUnsubscribe = null;
        // Chart
        let userGrowthChart = null;
        // Data Caches
        let cachedTasks = [];
        let allUsersCache = [];
        let activeGroupMembers = []; 
        let currentFriendsData = []; // Cache for friend data {uid, name, email}
        // UI State
        let currentWeek = 1;
        let activeGroupStartDate = null;
        let activeGroupTotalWeeks = 4;
        let currentChatContext = { type: null, id: null, name: null };
        

        // --- UI Elements ---
        const ui = {
            // Screens
            authScreen: document.getElementById('auth-screen'),
            appScreen: document.getElementById('app-screen'),
            adminScreen: document.getElementById('admin-screen'),
            
            // Auth
            authForm: document.getElementById('auth-form'),
            authError: document.getElementById('auth-error'),
            authTitle: document.getElementById('auth-title'),
            authToggleText: document.getElementById('auth-toggle-text'),
            authToggleLink: document.getElementById('auth-toggle-link'),
            authSubmitBtn: document.getElementById('auth-submit-btn'),
            nameFieldContainer: document.getElementById('name-field-container'),
            
            // User App
            mainContent: document.getElementById('main-content'),
            statsContainer: document.getElementById('stats-container'),
            userEmail: document.getElementById('user-email'),
            logoutBtn: document.getElementById('logout-btn'),
            headerTitle: document.getElementById('header-title'),
            backToDashboardBtn: document.getElementById('back-to-dashboard-btn'),
            createGroupBtn: document.getElementById('create-group-btn'),
            joinGroupBtn: document.getElementById('join-group-btn'),
            leaveGroupBtn: document.getElementById('leave-group-btn'),
            friendsBtn: document.getElementById('friends-btn'),
            openChatBtn: document.getElementById('open-chat-btn'),
            
            // Admin App
            adminEmail: document.getElementById('admin-email'),
            adminLogoutBtn: document.getElementById('admin-logout-btn'),
            adminStatsContainer: document.getElementById('admin-stats-container'),
            usersTableBody: document.getElementById('users-table-body'),
            addUserBtn: document.getElementById('add-user-btn'),
            userForm: document.getElementById('user-form'),
            userModalTitle: document.getElementById('user-modal-title'),
            userIdInput: document.getElementById('user-id'),
            userNameInput: document.getElementById('user-name'),
            userEmailInput: document.getElementById('user-email-input'),
            userPasswordInput: document.getElementById('user-password'),
            passwordFieldContainer: document.getElementById('password-field-container'),

            // Group Modal
            groupForm: document.getElementById('group-form'),
            groupModalTitle: document.getElementById('group-modal-title'),
            createGroupView: document.getElementById('create-group-view'),
            joinGroupView: document.getElementById('join-group-view'),
            newGroupNameInput: document.getElementById('new-group-name'),
            joinGroupIdInput: document.getElementById('join-group-id'),
            groupStartMonthSelect: document.getElementById('group-start-month'),

            // Task Modal
            taskForm: document.getElementById('task-form'),
            deleteTaskBtn: document.getElementById('delete-task-btn'),
            taskIdInput: document.getElementById('task-id'),
            taskTimeInput: document.getElementById('task-time'),
            taskDateInput: document.getElementById('task-date'),
            taskPartnerInput: document.getElementById('task-partner'),
            taskPlatformInput: document.getElementById('task-platform'),
            taskContentInput: document.getElementById('task-content'),
            taskStatusInput: document.getElementById('task-status'),
            taskAssigneeInput: document.getElementById('task-assignee'),
            taskModalTitle: document.getElementById('task-modal-title'),

            // Friends Modal
            sendFriendRequestForm: document.getElementById('send-friend-request-form'),
            friendEmailInput: document.getElementById('friend-email-input'),
            friendRequestMessage: document.getElementById('friend-request-message'),
            friendRequestsList: document.getElementById('friend-requests-list'),
            friendsList: document.getElementById('friends-list'),

            // Chat Modal
            chatModal: document.getElementById('chat-modal'),
            chatTabGroup: document.getElementById('chat-tab-group'),
            chatTabFriends: document.getElementById('chat-tab-friends'),
            chatConversationsList: document.getElementById('chat-conversations-list'),
            chatView: document.getElementById('chat-view'),
            chatPlaceholder: document.getElementById('chat-placeholder'),
            chatHeader: document.getElementById('chat-header'),
            chatAvatar: document.getElementById('chat-avatar'),
            chatTitle: document.getElementById('chat-title'),
            chatSubtitle: document.getElementById('chat-subtitle'),
            chatMessages: document.getElementById('chat-messages'),
            chatInputForm: document.getElementById('chat-input-form'),
            chatInput: document.getElementById('chat-input'),
        };

        // --- Helper & Utility Functions ---

        // Debounce function to limit rapid calls
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        
        // --- Modal Control ---
        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => { // For transition
                modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            }, 10);
        };

        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200); // Wait for transition
        };
        
        const showMessage = (title, text, isError = false) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = text;
            const iconEl = document.getElementById('message-icon');
            if (isError) {
                iconEl.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
            } else {
                iconEl.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
            }
            openModal('message-modal');
        };

        const showConfirmation = (title, text, onConfirm) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-text').textContent = text;
            
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            // Clone and replace to remove old listeners
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            newOkBtn.addEventListener('click', () => {
                onConfirm();
                closeModal('confirm-modal');
            });
            newCancelBtn.addEventListener('click', () => closeModal('confirm-modal'));

            openModal('confirm-modal');
        };

        // --- Date Utilities ---
        function getNumberOfWeeks(year, month) {
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDayOfMonth.getDay(); 
            const firstDayIndex = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1; // Monday = 0
            const totalSlots = firstDayIndex + lastDayOfMonth.getDate();
            return Math.ceil(totalSlots / 7);
        }

        const getWeekDates = (weekNumber, groupStartDate) => {
            const baseDate = groupStartDate ? new Date(groupStartDate) : new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const firstDayOfWeek1 = new Date(baseDate);
            const dayOffset = (firstDayOfWeek1.getDay() === 0) ? 6 : firstDayOfWeek1.getDay() - 1;
            firstDayOfWeek1.setDate(firstDayOfWeek1.getDate() - dayOffset);

            const startDate = new Date(firstDayOfWeek1);
            startDate.setDate(startDate.getDate() + (weekNumber - 1) * 7);

            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                dates.push(d);
            }
            return dates;
        };
        
        const formatDate = (date) => date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        const formatFullDate = (timestamp) => {
            if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
            return timestamp.toDate().toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const formatTime = (timestamp) => {
            if (!timestamp || typeof timestamp.toDate !== 'function') return '';
            return timestamp.toDate().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }


        // --- Authentication ---
        const toggleAuthMode = (isLogin) => {
            ui.authTitle.textContent = isLogin ? 'Đăng Nhập' : 'Đăng Ký';
            ui.authSubmitBtn.textContent = isLogin ? 'Đăng Nhập' : 'Đăng Ký';
            ui.authToggleText.textContent = isLogin ? 'Chưa có tài khoản?' : 'Đã có tài khoản?';
            ui.authToggleLink.textContent = isLogin ? 'Đăng ký ngay' : 'Đăng nhập';
            ui.authError.classList.add('hidden');
            ui.authForm.reset();
            
            if (isLogin) {
                ui.nameFieldContainer.classList.add('hidden');
            } else {
                ui.nameFieldContainer.classList.remove('hidden');
            }
        };

        ui.authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthMode(ui.authTitle.textContent === 'Đăng Ký');
        });
        
        ui.authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const isLogin = ui.authTitle.textContent === 'Đăng Nhập';

            ui.authError.classList.add('hidden');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle the rest
                } else {
                    const name = document.getElementById('name').value.trim();
                    if (!name) {
                        ui.authError.textContent = 'Vui lòng nhập tên của bạn.';
                        ui.authError.classList.remove('hidden');
                        return;
                    }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    const userData = {
                        name: name,
                        email: userCredential.user.email,
                        groups: [],
                        friends: [],
                        friendRequests: [],
                        activeGroupId: null,
                        createdAt: Timestamp.now(),
                        status: 'pending' // Default status for new users
                    };
                    // Auto-assign 'admin' role if the email matches ADMIN_EMAIL
                    if (userCredential.user.email === ADMIN_EMAIL) {
                        userData.role = 'admin';
                        userData.status = 'active'; // Admin user is active by default
                    }

                    await setDoc(doc(db, "users", userCredential.user.uid), userData);
                    
                    // After registration, sign them out and show message
                    await signOut(auth);
                    showMessage('Đăng Ký Thành Công', 'Tài khoản của bạn đã được tạo và đang chờ quản trị viên phê duyệt. Vui lòng quay lại sau.');
                    toggleAuthMode(true);
                }
            } catch (error) {
                const message = {
                    'auth/user-not-found': 'Email chưa được đăng ký.',
                    'auth/wrong-password': 'Sai mật khẩu, vui lòng thử lại.',
                    'auth/email-already-in-use': 'Email này đã được sử dụng.',
                    'auth/weak-password': 'Mật khẩu phải có ít nhất 6 ký tự.',
                    'auth/invalid-email': 'Địa chỉ email không hợp lệ.',
                }[error.code] || 'Đã có lỗi xảy ra. Vui lòng thử lại.';
                ui.authError.textContent = message;
                ui.authError.classList.remove('hidden');
            }
        });
        
        const handleLogout = () => signOut(auth);
        ui.logoutBtn.addEventListener('click', handleLogout);
        ui.adminLogoutBtn.addEventListener('click', handleLogout);

        // --- Cleanup Listeners ---
        function cleanupAllListeners() {
            if (taskUnsubscribe) taskUnsubscribe();
            if (groupsUnsubscribe) groupsUnsubscribe();
            if (groupDocUnsubscribe) groupDocUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();
            if (friendRequestsUnsubscribe) friendRequestsUnsubscribe();
            if (chatMessagesUnsubscribe) chatMessagesUnsubscribe();
            taskUnsubscribe = null;
            groupsUnsubscribe = null;
            groupDocUnsubscribe = null;
            usersUnsubscribe = null;
            friendRequestsUnsubscribe = null;
            chatMessagesUnsubscribe = null;
        }

        // --- App Initializer on Auth State Change ---
        onAuthStateChanged(auth, async (user) => {
            cleanupAllListeners();
            cachedTasks = [];
            allUsersCache = [];
            activeGroupMembers = [];
            currentFriendsData = [];
            activeGroupId = null;
            isAdmin = false;
            currentUser = null;
            currentUserData = null;

            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    currentUserData = { uid: user.uid, ...userDoc.data() };
                    const userStatus = currentUserData.status || 'active';

                    if (userStatus !== 'active') {
                        let message = 'Tài khoản của bạn đang chờ quản trị viên phê duyệt.';
                        if (userStatus === 'suspended') {
                            message = 'Tài khoản của bạn đã bị khóa.';
                        }
                        await signOut(auth); 
                        showMessage('Truy Cập Bị Từ Chối', message, true);
                        return;
                    }

                    if (currentUserData.role === 'admin') {
                        isAdmin = true;
                        ui.authScreen.classList.add('hidden');
                        ui.appScreen.classList.add('hidden');
                        ui.adminScreen.classList.remove('hidden');
                        ui.adminEmail.textContent = user.email;
                        loadAdminDashboard();
                    } else {
                        isAdmin = false;
                        ui.authScreen.classList.add('hidden');
                        ui.adminScreen.classList.add('hidden');
                        ui.appScreen.classList.remove('hidden');
                        ui.userEmail.textContent = user.email;
                        listenToUserData(user.uid);
                        listenToFriendRequests(user.uid);
                    }
                } else {
                    await signOut(auth);
                    showMessage('Lỗi Dữ Liệu', 'Không tìm thấy hồ sơ người dùng của bạn. Vui lòng liên hệ quản trị viên.', true);
                }
            } else {
                ui.authScreen.classList.remove('hidden');
                ui.appScreen.classList.add('hidden');
                ui.adminScreen.classList.add('hidden');
                ui.mainContent.innerHTML = '';
            }
        });
        
        // ======================================================================
        // ========================= ADMIN SECTION ==============================
        // ======================================================================
        
        function loadAdminDashboard() {
            listenToAllUsers();
        }
        
        window.updateUserStatus = async (userId, newStatus) => {
            // LƯU Ý: Chức năng này yêu cầu cấu hình Firestore Security Rules phù hợp.
            // Xem ghi chú ở đầu thẻ <script> để biết thêm chi tiết.
            const userToUpdate = allUsersCache.find(u => u.id === userId);
            if (!userToUpdate || userToUpdate.email === ADMIN_EMAIL) {
                showMessage('Thao tác không được phép', 'Bạn không thể thay đổi trạng thái của tài khoản này.', true);
                renderUsersTable(allUsersCache); // Revert UI
                return;
            }

            const userRef = doc(db, "users", userId);
            try {
                await updateDoc(userRef, { status: newStatus });
                // onSnapshot sẽ tự động cập nhật UI
            } catch (error) {
                console.error("Error updating user status:", error);
                showMessage('Lỗi Phân Quyền', 'Không thể cập nhật trạng thái. Vui lòng kiểm tra Firestore Security Rules.', true);
                renderUsersTable(allUsersCache); 
            }
        };

        function listenToAllUsers() {
            if (usersUnsubscribe) usersUnsubscribe();
            const usersQuery = query(collection(db, "users"));
            usersUnsubscribe = onSnapshot(usersQuery, async (usersSnapshot) => {
                try {
                    allUsersCache = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsersTable(allUsersCache);

                    const groupsSnapshot = await getDocs(collection(db, "groups"));
                    const totalGroups = groupsSnapshot.size;

                    let totalTasks = 0;
                    const taskPromises = groupsSnapshot.docs.map(groupDoc => 
                        getDocs(collection(db, "groups", groupDoc.id, "tasks"))
                    );
                    const taskSnapshots = await Promise.all(taskPromises);
                    taskSnapshots.forEach(taskCollection => {
                        totalTasks += taskCollection.size;
                    });
                    
                    updateAdminStats(allUsersCache, totalGroups, totalTasks);
                    renderUserGrowthChart(allUsersCache);

                } catch(error) {
                    console.error("Error updating admin dashboard:", error);
                    ui.adminStatsContainer.innerHTML = `<div class="col-span-3 bg-red-100 text-red-700 p-4 rounded-lg">Không thể tải số liệu thống kê.</div>`;
                }
            }, (error) => {
                console.error("Failed to listen to users collection:", error);
                const errorMessage = `Lỗi tải danh sách người dùng. Vui lòng kiểm tra quyền truy cập Firestore (Security Rules). Lỗi: ${error.message}`;
                ui.usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-600">${errorMessage}</td></tr>`;
            });
        }

        function updateAdminStats(users, totalGroups, totalTasks) {
            const totalUsers = users.length;
            ui.adminStatsContainer.innerHTML = `
                <div class="stat-card bg-blue-50">
                    <div class="stat-icon text-blue-500"><i class="fas fa-users"></i></div>
                    <div class="stat-value text-blue-600">${totalUsers}</div>
                    <div class="stat-label">Tổng người dùng</div>
                </div>
                <div class="stat-card bg-green-50">
                    <div class="stat-icon text-green-500"><i class="fas fa-layer-group"></i></div>
                    <div class="stat-value text-green-600">${totalGroups}</div>
                    <div class="stat-label">Tổng số nhóm</div>
                </div>
                <div class="stat-card bg-indigo-50">
                    <div class="stat-icon text-indigo-500"><i class="fas fa-tasks"></i></div>
                    <div class="stat-value text-indigo-600">${totalTasks}</div>
                    <div class="stat-label">Tổng công việc</div>
                </div>
                <style>
                    .stat-card { border-radius: 12px; padding: 1.5rem; text-align: center; }
                    .stat-icon { font-size: 2rem; margin-bottom: 0.75rem; }
                    .stat-value { font-size: 2.25rem; font-weight: 700; }
                    .stat-label { font-size: 0.875rem; color: #6b7280; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
                </style>
            `;
        }
        
        function renderUserGrowthChart(users) {
            const ctx = document.getElementById('user-growth-chart')?.getContext('2d');
            if (!ctx) return;

            const usersByMonth = {};
            users.forEach(user => {
                if (user.createdAt && typeof user.createdAt.toDate === 'function') {
                    const date = user.createdAt.toDate();
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    usersByMonth[monthKey] = (usersByMonth[monthKey] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(usersByMonth).sort();
            
            const labels = [];
            const data = [];
            if (sortedMonths.length > 0) {
                const firstMonth = new Date(sortedMonths[0] + "-01T00:00:00");
                const lastMonth = new Date();
                
                let currentMonth = firstMonth;
                while(currentMonth <= lastMonth) {
                    const monthKey = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
                    labels.push(`Tháng ${monthKey.split('-')[1]}/${monthKey.split('-')[0]}`);
                    data.push(usersByMonth[monthKey] || 0);
                    currentMonth.setMonth(currentMonth.getMonth() + 1);
                }
            }


            if (userGrowthChart) {
                userGrowthChart.destroy();
            }

            userGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số người dùng mới',
                        data: data,
                        fill: true,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(199, 210, 254, 0.5)',
                        tension: 0.3,
                        pointBackgroundColor: 'rgb(79, 70, 229)',
                        pointRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Show only whole numbers
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Biểu Đồ Tăng Trưởng Người Dùng',
                            font: { size: 18, family: "'Be Vietnam Pro', sans-serif" },
                            padding: { bottom: 20 }
                        }
                    }
                }
            });
        }


        function renderUsersTable(users) {
            if (!ui.usersTableBody) return;
            
            const sortedUsers = [...users].sort((a, b) => {
                const statusA = a.status || 'active';
                const statusB = b.status || 'active';
                if (statusA === 'pending' && statusB !== 'pending') return -1;
                if (statusA !== 'pending' && statusB === 'pending') return 1;
                return 0; // Keep original order for others
            });
            
            ui.usersTableBody.innerHTML = sortedUsers.map(user => {
                const status = user.status || 'active';
                let statusBadge;
                switch (status) {
                    case 'active':
                        statusBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Hoạt động</span>`;
                        break;
                    case 'pending':
                        statusBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Chờ duyệt</span>`;
                        break;
                    case 'suspended':
                        statusBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Bị khóa</span>`;
                        break;
                    default:
                        statusBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Không rõ</span>`;
                }

                const canModify = user.email !== ADMIN_EMAIL;
                let actionsHtml = '';
                if(canModify) {
                    actionsHtml += `<button onclick="openEditUserModal('${user.id}')" class="font-medium text-indigo-600 hover:underline">Sửa</button>`;
                    if(status === 'active') {
                        actionsHtml += `<button onclick="updateUserStatus('${user.id}', 'suspended')" class="font-medium text-orange-600 hover:underline">Khóa</button>`;
                    } else if (status === 'pending') {
                         actionsHtml += `<button onclick="updateUserStatus('${user.id}', 'active')" class="font-medium text-green-600 hover:underline">Duyệt</button>`;
                    } else if (status === 'suspended') {
                        actionsHtml += `<button onclick="updateUserStatus('${user.id}', 'active')" class="font-medium text-green-600 hover:underline">Mở khóa</button>`;
                    }
                    actionsHtml += `<button onclick="handleDeleteUser('${user.id}', '${user.name}')" class="font-medium text-red-600 hover:underline">Xóa</button>`;
                }

                return `
                    <tr class="bg-white border-b hover:bg-gray-50 ${status === 'pending' ? 'bg-yellow-50' : ''}">
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${user.name || 'N/A'}</td>
                        <td class="px-6 py-4">${user.email}</td>
                        <td class="px-6 py-4">${formatFullDate(user.createdAt)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                user.role === 'admin' 
                                ? 'bg-indigo-100 text-indigo-800' 
                                : 'bg-gray-100 text-gray-800'
                            }">
                                ${user.role === 'admin' ? 'Admin' : 'User'}
                            </span>
                        </td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 flex items-center gap-3">
                           ${actionsHtml}
                        </td>
                    </tr>
                `;
            }).join('');
        }


        ui.addUserBtn.addEventListener('click', () => {
            ui.userForm.reset();
            ui.userIdInput.value = '';
            ui.userModalTitle.textContent = 'Thêm người dùng mới';
            ui.userEmailInput.disabled = false;
            ui.passwordFieldContainer.classList.remove('hidden');
            ui.userPasswordInput.required = true;
            openModal('user-modal');
        });

        window.openEditUserModal = (userId) => {
            const user = allUsersCache.find(u => u.id === userId);
            if (!user) {
                showMessage('Lỗi', 'Không tìm thấy người dùng.', true);
                return;
            }
            ui.userForm.reset();
            ui.userModalTitle.textContent = 'Chỉnh sửa người dùng';
            ui.userIdInput.value = user.id;
            ui.userNameInput.value = user.name;
            ui.userEmailInput.value = user.email;
            ui.userEmailInput.disabled = true; // Cannot change email
            ui.passwordFieldContainer.classList.add('hidden'); // For simplicity, password change should be a separate function
            openModal('user-modal');
        };
        
        ui.userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = ui.userIdInput.value;
            const name = ui.userNameInput.value;
            const email = ui.userEmailInput.value;
            const password = ui.userPasswordInput.value;
            
            try {
                if (userId) { // Editing existing user
                    // LƯU Ý: Chức năng này yêu cầu cấu hình Firestore Security Rules phù hợp.
                    const userRef = doc(db, "users", userId);
                    await updateDoc(userRef, { name: name });
                    showMessage('Thành công', 'Đã cập nhật thông tin người dùng.');
                } else { // Creating new user by admin
                    // ##### LƯU Ý VỀ VIỆC TẠO NGƯỜI DÙNG TỪ TRANG ADMIN #####
                    // Việc tạo tài khoản người dùng trực tiếp từ client-side (như đoạn code dưới đây)
                    // là một GIẢI PHÁP TẠM THỜI và không đáng tin cậy. Cách làm này khởi tạo một
                    // ứng dụng Firebase thứ hai tạm thời, có thể gặp lỗi hoặc bị Firebase hạn chế.
                    //
                    // GIẢI PHÁP ĐÚNG ĐẮN VÀ BẢO MẬT là sử dụng Firebase Cloud Functions.
                    // Admin sẽ gọi một function trên server, và function đó với quyền admin sẽ
                    // tạo người dùng một cách an toàn.
                    // Tham khảo: https://firebase.google.com/docs/functions/callable
                    //
                    // Ngoài ra, để `setDoc` bên dưới thành công, bạn cũng cần có Security Rule
                    // cho phép admin tạo document trong collection 'users'.
                    
                    const tempApp = initializeApp(firebaseConfig, `Secondary-${Date.now()}`); 
                    const tempAuth = getAuth(tempApp);
                    const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                    await signOut(tempAuth); 

                    const userData = {
                        name: name,
                        email: email,
                        groups: [],
                        friends: [],
                        friendRequests: [],
                        activeGroupId: null,
                        createdAt: Timestamp.now(),
                        status: 'active' // Admin-created users are active by default
                    };
                    if (email === ADMIN_EMAIL) {
                        userData.role = 'admin';
                    }
                    await setDoc(doc(db, "users", userCredential.user.uid), userData);
                    showMessage('Thành công', 'Đã tạo người dùng mới.');
                }
                closeModal('user-modal');
            } catch (error) {
                console.error("User form error:", error);
                showMessage('Lỗi', `Không thể lưu người dùng: ${error.message}. Vui lòng kiểm tra Security Rules.`, true);
            }
        });
        
        window.handleDeleteUser = (userId, userName) => {
            // LƯU Ý: Chức năng này yêu cầu cấu hình Firestore Security Rules phù hợp.
            if (!userId) return;
            showConfirmation(`Xóa người dùng "${userName}"?`, 
            'Hành động này sẽ xóa dữ liệu người dùng khỏi Firestore nhưng không xóa tài khoản khỏi hệ thống xác thực. Đây là một hạn chế của việc xóa từ phía client. Tiếp tục?',
            async () => {
                try {
                    await deleteDoc(doc(db, "users", userId));
                    showMessage('Thành công', `Đã xóa người dùng "${userName}" khỏi cơ sở dữ liệu.`);
                } catch (error) {
                    console.error("Delete user error:", error);
                    showMessage('Lỗi', 'Không thể xóa người dùng. Vui lòng kiểm tra Security Rules.', true);
                }
            });
        };

        // ======================================================================
        // ======================== USER SECTION ================================
        // ======================================================================

        function listenToUserData(uid) {
            const userDocRef = doc(db, "users", uid);
            groupsUnsubscribe = onSnapshot(userDocRef, (userDoc) => {
                try {
                    if (!userDoc.exists()) return;
                    currentUserData = { uid: userDoc.id, ...userDoc.data()};
                    const newActiveGroupId = currentUserData.activeGroupId;

                    if (newActiveGroupId !== activeGroupId) {
                        activeGroupId = newActiveGroupId;
                        
                        if (activeGroupId) {
                            loadScheduleView(activeGroupId);
                        } else {
                            cleanupAllListeners(); // Clean up old listeners
                            listenToUserData(uid); // Re-establish the main listener
                            listenToFriendRequests(uid);
                            loadGroupDashboard(currentUserData.groups || []);
                        }
                    } else if (!activeGroupId && currentUserData.groups) {
                        loadGroupDashboard(currentUserData.groups || []);
                    }
                } catch (error) {
                    console.error("Critical error in user data listener:", error);
                    showMessage('Lỗi Hệ Thống', 'Gặp lỗi nghiêm trọng khi xử lý dữ liệu người dùng. Vui lòng tải lại trang.', true);
                }
            });
        }
        
        // --- Group Management ---
        function populateMonthSelector() {
            const select = ui.groupStartMonthSelect;
            select.innerHTML = '';
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            for (let i = 0; i < 6; i++) {
                const date = new Date(currentYear, currentMonth + i, 1);
                const option = document.createElement('option');
                option.value = date.toISOString().split('T')[0];
                option.textContent = `Tháng ${date.getMonth() + 1}/${date.getFullYear()}`;
                select.appendChild(option);
            }
        }

        async function loadGroupDashboard(groupIds) {
            ui.headerTitle.textContent = 'Các Nhóm Của Tôi';
            ui.backToDashboardBtn.classList.add('hidden');
            ui.statsContainer.classList.add('hidden');
            ui.leaveGroupBtn.classList.add('hidden');
            
            if (groupIds.length === 0) {
                ui.mainContent.innerHTML = `
                    <div class="text-center bg-white p-8 rounded-xl shadow">
                        <h2 class="text-xl font-bold mb-2">Chào mừng bạn!</h2>
                        <p class="text-gray-600">Bạn chưa ở trong nhóm nào. Hãy tạo một nhóm mới hoặc tham gia bằng mã mời.</p>
                    </div>`;
                return;
            }

            const groupPromises = groupIds.map(id => getDoc(doc(db, "groups", id)));
            const groupDocs = await Promise.all(groupPromises);

            const content = groupDocs.map(doc => {
                if (!doc.exists()) return '';
                const data = doc.data();
                const isGroupAdmin = data.adminId === currentUser.uid;

                const deleteButtonHtml = isGroupAdmin ? `
                    <button onclick="deleteGroup(event, '${doc.id}', '${data.name}')" class="absolute top-2 right-2 w-8 h-8 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors flex items-center justify-center">
                        <i class="fas fa-trash-alt fa-sm"></i>
                    </button>
                ` : '';

                return `
                    <div class="group-card relative">
                        <div onclick="selectGroup('${doc.id}')" class="bg-white p-5 rounded-xl shadow hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer pr-12">
                            <div class="font-bold text-lg text-gray-800">${data.name}</div>
                            <div class="text-sm text-gray-500">${(data.members || []).length} thành viên</div>
                        </div>
                        ${deleteButtonHtml}
                    </div>`;
            }).join('');
            
            ui.mainContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${content}</div>`;
        }

        window.selectGroup = async (groupId) => {
            await updateDoc(doc(db, "users", currentUser.uid), { activeGroupId: groupId });
        };

        window.deleteGroup = async (event, groupId, groupName) => {
            event.stopPropagation();
            showConfirmation(`Xóa nhóm "${groupName}"?`, 'Hành động này không thể hoàn tác. Tất cả công việc và tin nhắn trong nhóm cũng sẽ bị xóa vĩnh viễn.', async () => {
                try {
                    const batch = writeBatch(db);
                    
                    // Delete all tasks in subcollection
                    const tasksRef = collection(db, "groups", groupId, "tasks");
                    const tasksSnapshot = await getDocs(tasksRef);
                    tasksSnapshot.docs.forEach(taskDoc => batch.delete(taskDoc.ref));
                    
                    // Delete all messages in subcollection
                    const messagesRef = collection(db, "groups", groupId, "messages");
                    const messagesSnapshot = await getDocs(messagesRef);
                    messagesSnapshot.docs.forEach(messageDoc => batch.delete(messageDoc.ref));
                    
                    // Delete the group itself
                    batch.delete(doc(db, "groups", groupId));
                    
                    await batch.commit();

                    // Update all members to remove the group
                    const groupDoc = await getDoc(doc(db, "groups", groupId));
                    if (groupDoc.exists() && groupDoc.data().members) {
                        const memberUpdates = groupDoc.data().members.map(memberId => {
                            const userRef = doc(db, "users", memberId);
                            return updateDoc(userRef, {
                                groups: arrayRemove(groupId),
                                activeGroupId: null // Reset active group if it was the deleted one
                            });
                        });
                        await Promise.all(memberUpdates);
                    }
                    
                    showMessage('Thành công', `Nhóm "${groupName}" đã được xóa.`);
                } catch (error) {
                    console.error("Delete group error:", error);
                    showMessage('Lỗi!', 'Không thể xóa nhóm. Vui lòng kiểm tra lại quyền hoặc thử lại.', true);
                }
            });
        };
        
        ui.backToDashboardBtn.addEventListener('click', async () => {
             await updateDoc(doc(db, "users", currentUser.uid), { activeGroupId: null });
        });

        ui.createGroupBtn.addEventListener('click', () => {
            ui.groupModalTitle.textContent = 'Tạo nhóm mới';
            ui.createGroupView.classList.remove('hidden');
            ui.joinGroupView.classList.add('hidden');
            ui.groupForm.reset();
            populateMonthSelector();
            openModal('group-modal');
        });

        ui.joinGroupBtn.addEventListener('click', () => {
            ui.groupModalTitle.textContent = 'Tham gia nhóm';
            ui.joinGroupView.classList.remove('hidden');
            ui.createGroupView.classList.add('hidden');
            ui.groupForm.reset();
            openModal('group-modal');
        });
        
        ui.leaveGroupBtn.addEventListener('click', () => {
            if (!activeGroupId) return;
            showConfirmation('Xác nhận rời nhóm', 'Bạn có chắc chắn muốn rời khỏi nhóm này không?', async () => {
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    const groupRef = doc(db, "groups", activeGroupId);

                    const batch = writeBatch(db);
                    batch.update(userRef, {
                        groups: arrayRemove(activeGroupId),
                        activeGroupId: null
                    });
                    batch.update(groupRef, {
                        members: arrayRemove(currentUser.uid)
                    });
                    await batch.commit();
                    
                    showMessage('Thành công', 'Bạn đã rời khỏi nhóm.');
                } catch (error) {
                    console.error("Leave group error:", error);
                    showMessage('Lỗi!', 'Không thể rời nhóm. Vui lòng thử lại.', true);
                }
            });
        });

        ui.groupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const isCreating = !ui.createGroupView.classList.contains('hidden');

            try {
                if (isCreating) {
                    const groupName = ui.newGroupNameInput.value.trim();
                    const selectedStartDate = new Date(ui.groupStartMonthSelect.value);

                    if (!groupName) {
                        showMessage('Lỗi', 'Vui lòng nhập tên nhóm.', true);
                        return;
                    }
                    
                    const groupRef = await addDoc(collection(db, "groups"), {
                        name: groupName,
                        adminId: currentUser.uid,
                        members: [currentUser.uid],
                        createdAt: Timestamp.now(),
                        startDate: Timestamp.fromDate(selectedStartDate),
                    });
                    
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        groups: arrayUnion(groupRef.id),
                        activeGroupId: groupRef.id
                    });

                    showMessage('Thành công!', `Đã tạo nhóm "${groupName}". Mã mời của nhóm là: ${groupRef.id}`);
                } else { // Join group logic
                    const groupId = ui.joinGroupIdInput.value.trim();
                    if (!groupId) {
                        showMessage('Lỗi', 'Vui lòng nhập mã mời.', true);
                        return;
                    }

                    const groupRef = doc(db, "groups", groupId);
                    const userRef = doc(db, "users", currentUser.uid);

                    const groupDoc = await getDoc(groupRef);
                    if (!groupDoc.exists()) {
                        showMessage('Lỗi', 'Mã nhóm không tồn tại hoặc không hợp lệ.', true);
                        return;
                    }

                    const batch = writeBatch(db);
                    batch.update(groupRef, { members: arrayUnion(currentUser.uid) });
                    batch.update(userRef, { 
                        groups: arrayUnion(groupId),
                        activeGroupId: groupId
                    });
                    await batch.commit();

                    showMessage('Thành công!', `Đã tham gia nhóm "${groupDoc.data().name}".`);
                }
                closeModal('group-modal');
            } catch (error) {
                console.error("Group form error:", error);
                let errorMessage = 'Không thể thực hiện thao tác. Vui lòng thử lại.';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Thao tác bị từ chối. Vui lòng kiểm tra lại mã mời.';
                } else if (error.code === 'not-found') {
                    errorMessage = 'Không tìm thấy nhóm với mã mời này.';
                }
                showMessage('Lỗi!', errorMessage, true);
            }
        });

        async function fetchAndCacheMembers(memberUids) {
            if (!memberUids || memberUids.length === 0) {
                activeGroupMembers = [];
                return;
            }
            
            try {
                const uniqueUids = [...new Set(memberUids)];
                const memberPromises = uniqueUids.map(uid => getDoc(doc(db, "users", uid)));
                const memberDocs = await Promise.all(memberPromises);
                
                activeGroupMembers = memberDocs
                    .filter(doc => doc.exists())
                    .map(doc => ({ uid: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Error fetching group members:", error);
                activeGroupMembers = [];
            }
        }
        
        async function loadScheduleView(groupId) {
            if (groupDocUnsubscribe) groupDocUnsubscribe();
            if (taskUnsubscribe) taskUnsubscribe();
        
            try {
                const groupDocRef = doc(db, "groups", groupId);
                groupDocUnsubscribe = onSnapshot(groupDocRef, async (doc) => {
                    if (!doc.exists()) {
                        showMessage('Thông Báo', 'Nhóm này đã bị xóa.', true);
                        ui.backToDashboardBtn.click();
                        return;
                    }
                    const groupData = doc.data();
                    
                    ui.headerTitle.textContent = `Lịch trình: ${groupData.name}`;
                    ui.backToDashboardBtn.classList.remove('hidden');
                    ui.statsContainer.classList.remove('hidden');
                    ui.leaveGroupBtn.classList.remove('hidden');
                    ui.mainContent.innerHTML = `<div id="schedule-container" class="bg-white p-4 md:p-6 rounded-xl shadow-lg"></div>`;
            
                    if (groupData.startDate && typeof groupData.startDate.toDate === 'function') {
                        activeGroupStartDate = groupData.startDate.toDate();
                        activeGroupTotalWeeks = getNumberOfWeeks(activeGroupStartDate.getFullYear(), activeGroupStartDate.getMonth());
                    } else {
                        activeGroupStartDate = null;
                        activeGroupTotalWeeks = 4;
                    }
                    
                    await fetchAndCacheMembers(groupData.members || []);
                    renderWeekNavigator();
                    renderSchedule();
                    renderTasks(cachedTasks); 
                }, async (error) => {
                    console.error("Group listener failed:", error);
                    showMessage('Lỗi Kết Nối', 'Mất kết nối tới dữ liệu nhóm.', true);
                    await updateDoc(doc(db, "users", currentUser.uid), { activeGroupId: null });
                });
        
                const tasksQuery = query(collection(db, "groups", groupId, "tasks"));
                taskUnsubscribe = onSnapshot(tasksQuery, (snapshot) => {
                    cachedTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTasks(cachedTasks);
                    updateStats(cachedTasks);
                }, (error) => {
                    console.error("Task listener failed:", error);
                    showMessage('Lỗi Lắng Nghe', 'Mất kết nối với dữ liệu công việc. Vui lòng tải lại trang.', true);
                });
        
            } catch (error) {
                console.error("Failed to load schedule view for group:", groupId, error);
                showMessage('Lỗi Tải Nhóm', 'Không thể tải được dữ liệu của nhóm này. Đang đưa bạn về trang chính.', true);
                await updateDoc(doc(db, "users", currentUser.uid), { activeGroupId: null });
            }
        }
        
        // --- Week Navigation & Schedule Grid ---
        function renderWeekNavigator() {
            if (!activeGroupStartDate) return;
            const weekDates = getWeekDates(currentWeek, activeGroupStartDate);
            const weekStart = weekDates[0];
            const weekEnd = weekDates[6];
            
            let weekButtonsHtml = '';
            for (let i = 1; i <= activeGroupTotalWeeks; i++) {
                weekButtonsHtml += `<button class="week-num-btn ${i === currentWeek ? 'active' : ''}" onclick="setWeek(${i})">${i}</button>`;
            }

            let navHtml = `
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="font-semibold text-gray-700 mb-3 md:mb-0">
                    Tuần ${currentWeek} (${formatDate(weekStart)} - ${formatDate(weekEnd)})
                </div>
                <div class="flex items-center gap-1">
                    <button class="week-btn" onclick="changeWeek(-1)" ${currentWeek === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                    ${weekButtonsHtml}
                    <button class="week-btn" onclick="changeWeek(1)" ${currentWeek === activeGroupTotalWeeks ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <style>
                .week-btn, .week-num-btn { padding: 8px 12px; border: none; border-radius: 6px; background: #e5e7eb; color: #374151; cursor: pointer; transition: all 0.2s; font-weight: 500; }
                .week-btn:hover:not(:disabled), .week-num-btn:hover { background: #d1d5db; }
                .week-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                .week-num-btn.active { background: #4f46e5; color: white; }
            </style>`;
            
            const container = document.getElementById('schedule-container');
            if (container) container.innerHTML = navHtml;
        }

        window.changeWeek = (delta) => {
            const newWeek = currentWeek + delta;
            if (newWeek >= 1 && newWeek <= activeGroupTotalWeeks) {
                setWeek(newWeek);
            }
        };
        
        window.setWeek = (week) => {
            currentWeek = week;
            renderWeekNavigator();
            renderSchedule();
            renderTasks(cachedTasks);
        };

        function renderSchedule() {
            const days = ["Thứ Hai", "Thứ Ba", "Thứ Tư", "Thứ Năm", "Thứ Sáu", "Thứ Bảy", "Chủ Nhật"];
            const timeSlots = ["00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00", "23:00"];
            
            const container = document.getElementById('schedule-container');
            if (!container) return;

            if (!activeGroupStartDate) {
                 container.insertAdjacentHTML('beforeend', '<p class="text-center text-red-500 p-4">Không thể hiển thị lịch vì nhóm này không có ngày bắt đầu hợp lệ.</p>');
                 return;
            }
            
            const weekDates = getWeekDates(currentWeek, activeGroupStartDate);

            let gridHtml = '<div class="schedule-grid grid" style="grid-template-columns: 60px repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border-radius: 8px; overflow: hidden;">';
            gridHtml += '<div class="bg-gray-200"></div>'; // Corner
            days.forEach((day, index) => {
                gridHtml += `<div class="bg-gray-200 text-center p-2 font-semibold text-sm text-gray-600">${day}<div class="font-normal text-xs">${formatDate(weekDates[index])}</div></div>`;
            });
            
            timeSlots.forEach(time => {
                gridHtml += `<div class="bg-gray-200 text-center p-2 font-medium text-xs text-gray-600 flex items-center justify-center">${time}</div>`;
                days.forEach((_, index) => {
                    const cellDate = weekDates[index];
                    const dateString = cellDate.toISOString().split('T')[0];
                    
                    const cellClasses = "grid-cell bg-white min-h-[100px] p-1.5 hover:bg-indigo-50 transition-colors space-y-1.5 overflow-y-auto custom-scrollbar";
                    const clickHandler = `onclick="openTaskModal(null, '${time}', '${dateString}')"`;

                    gridHtml += `<div class="${cellClasses}" data-time="${time}" data-date="${dateString}" ${clickHandler}></div>`;
                });
            });
            gridHtml += '</div>';

            const existingGrid = container.querySelector('.schedule-grid');
            if (existingGrid) existingGrid.remove();
            container.insertAdjacentHTML('beforeend', gridHtml);
        }

        // --- Task Handling ---
        function renderTasks(allTasks) {
            document.querySelectorAll('.task-card').forEach(card => card.remove());
            if (!activeGroupStartDate) return;
            const weekDates = getWeekDates(currentWeek, activeGroupStartDate).map(d => d.toISOString().split('T')[0]);
            
            allTasks.forEach(task => {
                if (!task || !task.date || !task.time) return; 

                if (weekDates.includes(task.date)) {
                    const cell = document.querySelector(`.grid-cell[data-date="${task.date}"][data-time="${task.time}"]`);
                    if (cell) {
                        const assignee = activeGroupMembers.find(m => m.uid === task.assigneeUid);
                        const assigneeName = assignee ? (assignee.name || assignee.email) : 'Chưa gán';

                        const taskEl = document.createElement('div');
                        const platformClass = (task.platform || 'unknown').toLowerCase();
                        const statusClass = (task.status || 'Chưa làm').replace(/\s+/g, '-').toLowerCase();

                        taskEl.className = `task-card border-l-4 p-2 rounded cursor-pointer transition-all hover:shadow-md hover:translate-x-1 platform-${platformClass}`;
                        taskEl.innerHTML = `
                            <div class="font-bold text-sm text-gray-800">${task.partner || 'N/A'}</div>
                            <div class="text-xs text-gray-600 truncate">${task.content || ''}</div>
                            <div class="text-xs text-indigo-500 font-medium mt-1">@${assigneeName}</div>
                            <span class="task-status text-xs font-medium px-2 py-0.5 rounded-full mt-1 inline-block status-${statusClass}">${task.status || 'Chưa làm'}</span>
                        `;
                        taskEl.onclick = (e) => {
                            e.stopPropagation();
                            openTaskModal(task);
                        };
                        cell.appendChild(taskEl);
                    }
                }
            });
        }
        
        window.openTaskModal = (task, time, date) => {
            ui.taskForm.reset();
            
            ui.taskAssigneeInput.innerHTML = '';
            if (activeGroupMembers.length > 0) {
                activeGroupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.uid;
                    option.textContent = member.name || member.email;
                    ui.taskAssigneeInput.appendChild(option);
                });
            }

            if (task) {
                ui.taskModalTitle.textContent = 'Chỉnh sửa công việc';
                ui.taskIdInput.value = task.id;
                ui.taskPartnerInput.value = task.partner;
                ui.taskPlatformInput.value = task.platform;
                ui.taskContentInput.value = task.content;
                ui.taskStatusInput.value = task.status;
                ui.taskTimeInput.value = task.time;
                ui.taskDateInput.value = task.date;
                ui.taskAssigneeInput.value = task.assigneeUid || currentUser.uid;
                ui.deleteTaskBtn.classList.remove('hidden');
            } else {
                ui.taskModalTitle.textContent = 'Tạo công việc mới';
                ui.taskIdInput.value = '';
                ui.taskTimeInput.value = time;
                ui.taskDateInput.value = date;
                ui.taskAssigneeInput.value = currentUser.uid;
                ui.deleteTaskBtn.classList.add('hidden');
            }
            openModal('task-modal');
        };

        ui.taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskId = ui.taskIdInput.value;
            const taskData = {
                partner: ui.taskPartnerInput.value,
                platform: ui.taskPlatformInput.value,
                content: ui.taskContentInput.value,
                status: ui.taskStatusInput.value,
                time: ui.taskTimeInput.value,
                date: ui.taskDateInput.value,
                assigneeUid: ui.taskAssigneeInput.value,
                authorUid: currentUser.uid,
                updatedAt: Timestamp.now()
            };
            
            try {
                if (taskId) {
                    await updateDoc(doc(db, "groups", activeGroupId, "tasks", taskId), taskData);
                } else {
                    taskData.createdAt = Timestamp.now();
                    await addDoc(collection(db, "groups", activeGroupId, "tasks"), taskData);
                }
                closeModal('task-modal');
            } catch (error) {
                 showMessage('Lỗi', 'Không thể lưu công việc.', true);
            }
        });
        
        ui.deleteTaskBtn.addEventListener('click', () => {
            const taskId = ui.taskIdInput.value;
            if (!taskId) return;
            
            showConfirmation('Xác nhận xóa', 'Bạn có chắc chắn muốn xóa công việc này không?', async () => {
                try {
                    await deleteDoc(doc(db, "groups", activeGroupId, "tasks", taskId));
                    showMessage('Thành công', 'Đã xóa công việc.');
                    closeModal('task-modal');
                } catch (error) {
                    showMessage('Lỗi', 'Không thể xóa công việc.', true);
                }
            });
        });

        // --- Statistics ---
        function updateStats(allTasks) {
            const statusCounts = { 'Chưa làm': 0, 'Đang làm': 0, 'Hoàn thành': 0, 'Bù': 0 };
            let totalTasks = 0;
            if (activeGroupStartDate){
                const monthStart = new Date(activeGroupStartDate);
                
                const monthTasks = allTasks.filter(task => {
                    if (!task.date) return false;
                    const taskDate = new Date(task.date);
                    return taskDate.getFullYear() === monthStart.getFullYear() && taskDate.getMonth() === monthStart.getMonth();
                });
                
                totalTasks = monthTasks.length;
                monthTasks.forEach(task => {
                    const status = task.status || 'Chưa làm';
                    if (statusCounts[status] !== undefined) {
                        statusCounts[status]++;
                    }
                });
            }

            ui.statsContainer.innerHTML = `
                <div class="stat-card"><div class="stat-value">${totalTasks}</div><div class="stat-label">CV Tháng</div></div>
                <div class="stat-card"><div class="stat-value text-gray-500">${statusCounts['Chưa làm']}</div><div class="stat-label">Chưa làm</div></div>
                <div class="stat-card"><div class="stat-value text-blue-500">${statusCounts['Đang làm']}</div><div class="stat-label">Đang làm</div></div>
                <div class="stat-card"><div class="stat-value text-green-500">${statusCounts['Hoàn thành']}</div><div class="stat-label">Hoàn thành</div></div>
                <div class="stat-card"><div class="stat-value text-yellow-500">${statusCounts['Bù']}</div><div class="stat-label">CV Bù</div></div>
                <div class="stat-card"><div class="stat-value text-xs break-all">${activeGroupId || 'N/A'}</div><div class="stat-label">ID Nhóm</div></div>        
                 <style>
                      .stat-card { background: white; border-radius: 12px; padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: center;}
                      .stat-value { font-size: 1.75rem; font-weight: 700; color: #4f46e5; }
                      .stat-label { font-size: 0.75rem; color: #6b7280; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
                 </style>
            `;
        }

        // ======================================================================
        // ======================== FRIENDS SECTION =============================
        // ======================================================================
        
        ui.friendsBtn.addEventListener('click', async () => {
            if (!currentUserData) return;
            // The onSnapshot listener will keep these up to date, just need to render
            renderFriendsUI(currentUserData.friendRequests || []);
            await loadAndRenderFriendsList(currentUserData.friends || []);
            openModal('friends-modal');
        });

        function listenToFriendRequests(uid) {
            if (friendRequestsUnsubscribe) friendRequestsUnsubscribe();
            const userRef = doc(db, 'users', uid);
            // This listener is part of the main `listenToUserData`, so friend data
            // will be updated automatically. We just need to ensure the UI is rendered
            // when the friends modal is opened.
        }
        
        async function loadAndRenderFriendsList(friendUids) {
            ui.friendsList.innerHTML = '<li class="text-gray-400 p-2">Đang tải...</li>';
            if (friendUids.length === 0) {
                currentFriendsData = [];
                ui.friendsList.innerHTML = '<li class="text-gray-400 p-2">Chưa có bạn bè.</li>';
                return;
            }
            try {
                const friendPromises = friendUids.map(uid => getDoc(doc(db, 'users', uid)));
                const friendDocs = await Promise.all(friendPromises);
                currentFriendsData = friendDocs
                    .filter(d => d.exists())
                    .map(d => ({ uid: d.id, ...d.data() }));

                if (currentFriendsData.length === 0) {
                     ui.friendsList.innerHTML = '<li class="text-gray-400 p-2">Chưa có bạn bè.</li>';
                     return;
                }

                ui.friendsList.innerHTML = currentFriendsData.map(friend => `
                    <li class="px-3 py-2 bg-gray-100 rounded flex justify-between items-center">
                        <span>${friend.name || friend.email}</span>
                        <button onclick="unfriend('${friend.uid}', '${friend.name}')" class="text-xs text-red-500 hover:underline">Hủy kết bạn</button>
                    </li>
                `).join('');
            } catch (error) {
                console.error("Error loading friends list:", error);
                ui.friendsList.innerHTML = '<li class="text-red-500 p-2">Lỗi tải danh sách bạn bè.</li>';
            }
        }
        
        async function renderFriendsUI(requests) {
            const pendingRequests = requests.filter(r => r.status === 'pending');
            if (pendingRequests.length > 0) {
                 ui.friendRequestsList.innerHTML = pendingRequests.map(r => `
                    <li class="px-3 py-2 bg-yellow-50 rounded flex justify-between items-center">
                        <span>${r.fromName || r.fromEmail}</span>
                        <div class="flex gap-2">
                            <button class="text-green-600 hover:underline text-sm" onclick="handleFriendRequest('${r.fromUid}', true)">Chấp nhận</button>
                            <button class="text-red-600 hover:underline text-sm" onclick="handleFriendRequest('${r.fromUid}', false)">Từ chối</button>
                        </div>
                    </li>
                `).join('');
            } else {
                 ui.friendRequestsList.innerHTML = '<li class="text-gray-400 p-2">Không có lời mời mới.</li>';
            }
        }
        
        const showFriendRequestMessage = (message, isError = false) => {
            ui.friendRequestMessage.textContent = message;
            ui.friendRequestMessage.className = `text-sm mb-2 ${isError ? 'text-red-600' : 'text-green-600'}`;
        };

        ui.sendFriendRequestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showFriendRequestMessage('', false);
            const email = ui.friendEmailInput.value.trim().toLowerCase();
            if (!email || !currentUser) return;
            if (email === currentUser.email) {
                showFriendRequestMessage('Không thể kết bạn với chính mình!', true);
                return;
            }
            try {
                // NOTE: This query requires a Firestore index on the 'email' field in the 'users' collection.
                // If you get a permission error in the console, create this index in the Firebase console.
                const q = query(collection(db, 'users'), where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showFriendRequestMessage('Không tìm thấy người dùng với email này.', true);
                    return;
                }
                const foundUserDoc = querySnapshot.docs[0];
                const foundUser = { id: foundUserDoc.id, ...foundUserDoc.data() };


                if ((currentUserData.friends || []).includes(foundUser.id)) {
                    showFriendRequestMessage('Hai bạn đã là bạn bè.', true);
                    return;
                }

                const existingRequest = (foundUser.friendRequests || []).find(r => r.fromUid === currentUser.uid && r.status === 'pending');
                if(existingRequest) {
                    showFriendRequestMessage('Đã gửi lời mời, vui lòng chờ xác nhận.', false);
                    return;
                }
                
                const newRequest = {
                    fromUid: currentUser.uid,
                    fromEmail: currentUser.email,
                    fromName: currentUserData.name || currentUser.email,
                    status: 'pending',
                    sentAt: Timestamp.now()
                };

                await updateDoc(doc(db, 'users', foundUser.id), {
                    friendRequests: arrayUnion(newRequest)
                });
                
                showFriendRequestMessage('Đã gửi lời mời kết bạn!', false);
                ui.friendEmailInput.value = '';
            } catch (err) {
                console.error("Error sending friend request", err);
                showFriendRequestMessage('Lỗi gửi lời mời! Vui lòng thử lại.', true);
            }
        });
        
        window.handleFriendRequest = async (fromUid, accept) => {
            if (!currentUser || !currentUserData) return;

            const requestToHandle = (currentUserData.friendRequests || []).find(r => r.fromUid === fromUid && r.status === 'pending');

            if (!requestToHandle) {
                console.log("Không tìm thấy lời mời kết bạn hoặc đã được xử lý.");
                return;
            }

            const userRef = doc(db, 'users', currentUser.uid);
            const batch = writeBatch(db);

            try {
                // Luôn xóa lời mời kết bạn khỏi danh sách
                batch.update(userRef, { friendRequests: arrayRemove(requestToHandle) });

                if (accept) {
                    const friendRef = doc(db, 'users', fromUid);
                    // Thêm bạn bè cho cả hai người dùng
                    batch.update(userRef, { friends: arrayUnion(fromUid) });
                    batch.update(friendRef, { friends: arrayUnion(currentUser.uid) });
                }

                await batch.commit();

                // Cập nhật giao diện ngay lập tức thay vì chờ onSnapshot
                // 1. Cập nhật danh sách lời mời trong cache và re-render
                currentUserData.friendRequests = (currentUserData.friendRequests || []).filter(r => r.fromUid !== fromUid);
                renderFriendsUI(currentUserData.friendRequests);
                
                // 2. Nếu chấp nhận, cập nhật danh sách bạn bè trong cache và re-render
                if (accept) {
                    // Đảm bảo không thêm trùng lặp
                    if (!(currentUserData.friends || []).includes(fromUid)) {
                        currentUserData.friends.push(fromUid);
                    }
                    await loadAndRenderFriendsList(currentUserData.friends); // Tải lại toàn bộ list để có tên bạn mới
                }

            } catch (error) {
                console.error("Lỗi khi xử lý lời mời kết bạn: ", error);
                showMessage('Lỗi', 'Không thể xử lý lời mời. Vui lòng thử lại.', true);
            }
        };

        window.unfriend = async (friendUid, friendName) => {
             showConfirmation(`Hủy kết bạn với ${friendName || 'người này'}?`, 
             'Bạn có chắc muốn hủy kết bạn không?', 
             async () => {
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const friendRef = doc(db, 'users', friendUid);
                    
                    const batch = writeBatch(db);
                    batch.update(userRef, { friends: arrayRemove(friendUid) });
                    batch.update(friendRef, { friends: arrayRemove(currentUser.uid) });
                    await batch.commit();
                    
                    // Cập nhật cache cục bộ và re-render UI ngay lập tức
                    currentUserData.friends = (currentUserData.friends || []).filter(uid => uid !== friendUid);
                    await loadAndRenderFriendsList(currentUserData.friends);
                    
                    showMessage('Thành công', 'Đã hủy kết bạn.');
                } catch(error) {
                    console.error("Lỗi khi hủy kết bạn: ", error);
                    showMessage('Lỗi', 'Không thể hủy kết bạn. Vui lòng thử lại.', true);
                }
             });
        }
        
        // ======================================================================
        // ========================== CHAT SECTION ==============================
        // ======================================================================

        ui.openChatBtn.addEventListener('click', () => {
            openModal('chat-modal');
            renderChatSidebar('group');
        });

        ui.chatTabGroup.addEventListener('click', () => {
            ui.chatTabGroup.classList.add('bg-indigo-100', 'text-indigo-700');
            ui.chatTabFriends.classList.remove('bg-indigo-100', 'text-indigo-700');
            renderChatSidebar('group');
        });
        
        ui.chatTabFriends.addEventListener('click', () => {
            ui.chatTabFriends.classList.add('bg-indigo-100', 'text-indigo-700');
            ui.chatTabGroup.classList.remove('bg-indigo-100', 'text-indigo-700');
            renderChatSidebar('friend');
        });

        async function renderChatSidebar(type) {
            ui.chatConversationsList.innerHTML = '<div class="text-gray-400 text-center p-4">Đang tải...</div>';
            let conversations = [];
            if (type === 'group' && currentUserData.groups) {
                const groupPromises = currentUserData.groups.map(id => getDoc(doc(db, "groups", id)));
                const groupDocs = await Promise.all(groupPromises);
                conversations = groupDocs.filter(d => d.exists()).map(d => ({
                    id: d.id,
                    name: d.data().name,
                    subtitle: `${d.data().members.length} thành viên`,
                    type: 'group'
                }));
            } else if (type === 'friend' && currentUserData.friends) {
                if (currentFriendsData.length !== currentUserData.friends.length) {
                   await loadAndRenderFriendsList(currentUserData.friends);
                }
                conversations = currentFriendsData.map(f => ({
                    id: f.uid,
                    name: f.name || f.email,
                    subtitle: f.email,
                    type: 'friend'
                }));
            }

            if(conversations.length > 0) {
                 ui.chatConversationsList.innerHTML = conversations.map(convo => `
                    <div onclick="openChatConversation('${convo.id}', '${convo.type}')" 
                         class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-200 cursor-pointer transition-colors ${currentChatContext.id === convo.id ? 'bg-indigo-100' : ''}">
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white flex-shrink-0">
                            ${(convo.name[0] || '?').toUpperCase()}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="font-semibold text-sm text-gray-800 truncate">${convo.name}</div>
                            <div class="text-xs text-gray-500 truncate">${convo.subtitle}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                 ui.chatConversationsList.innerHTML = `<div class="text-gray-400 text-center p-4">Không có ${type === 'group' ? 'nhóm' : 'bạn bè'} nào.</div>`;
            }
        }
        
        window.openChatConversation = async (id, type) => {
            if (chatMessagesUnsubscribe) chatMessagesUnsubscribe();
            ui.chatView.classList.remove('hidden');
            ui.chatPlaceholder.classList.add('hidden');

            let conversationRef;
            let title, subtitle;
            let membersForAvatar = [];
            
            if (type === 'group') {
                const groupDoc = await getDoc(doc(db, 'groups', id));
                if (!groupDoc.exists()) return;
                const groupData = groupDoc.data();
                title = groupData.name;
                subtitle = `${groupData.members.length} thành viên`;
                conversationRef = collection(db, 'groups', id, 'messages');
                await fetchAndCacheMembers(groupData.members); // Make sure members are cached
                membersForAvatar = activeGroupMembers;
            } else { // friend
                const friendDoc = await getDoc(doc(db, 'users', id));
                if (!friendDoc.exists()) return;
                title = friendDoc.data().name || friendDoc.data().email;
                subtitle = 'Bạn bè';
                // Create a consistent chat ID for 1-on-1 chats
                const chatId = [currentUser.uid, id].sort().join('_');
                conversationRef = collection(db, 'chats', chatId, 'messages');
                membersForAvatar = [currentUserData, {uid: friendDoc.id, ...friendDoc.data()}];
            }
            
            currentChatContext = { id, type, name: title, members: membersForAvatar };

            ui.chatTitle.textContent = title;
            ui.chatSubtitle.textContent = subtitle;
            ui.chatAvatar.textContent = (title[0] || '?').toUpperCase();
            
            const q = query(conversationRef, orderBy("sentAt", "desc"), limit(50));
            chatMessagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).reverse();
                renderChatMessages(messages);
            });
        }
        
        function renderChatMessages(messages) {
            ui.chatMessages.innerHTML = messages.map(msg => {
                const isMe = msg.senderUid === currentUser.uid;
                
                const sender = currentChatContext.members.find(m => m.uid === msg.senderUid) || {name: '...', email: '...'}
                const senderName = isMe ? 'Bạn' : sender.name || sender.email;
                
                return `
                    <div class="flex gap-2.5 ${isMe ? 'justify-end' : 'justify-start'}">
                        ${!isMe ? `<div class="w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center text-sm text-white font-bold" title="${senderName}">${(senderName[0] || '?').toUpperCase()}</div>` : ''}
                        <div class="flex flex-col gap-1 max-w-[70%]">
                            <div class="flex items-center space-x-2 rtl:space-x-reverse ${isMe ? 'justify-end' : ''}">
                                <span class="text-xs font-semibold text-gray-900">${senderName}</span>
                                <span class="text-xs font-normal text-gray-500">${formatTime(msg.sentAt)}</span>
                            </div>
                            <div class="leading-snug p-2.5 rounded-xl ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none shadow-sm'}">
                                <p class="text-sm font-normal">${msg.text}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
        }

        ui.chatInputForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = ui.chatInput.value.trim();
            if(!text || !currentChatContext.id) return;

            let conversationRef;
            if(currentChatContext.type === 'group') {
                conversationRef = collection(db, 'groups', currentChatContext.id, 'messages');
            } else {
                const chatId = [currentUser.uid, currentChatContext.id].sort().join('_');
                conversationRef = collection(db, 'chats', chatId, 'messages');
            }

            try {
                await addDoc(conversationRef, {
                    text: text,
                    senderUid: currentUser.uid,
                    sentAt: Timestamp.now()
                });
                ui.chatInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showMessage('Lỗi', 'Không thể gửi tin nhắn.', true);
            }
        });
        
    </script>
</body>
</html>
